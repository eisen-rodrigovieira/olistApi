CREATE OR REPLACE PROCEDURE AD_STP_MKP_GERA_NOTA_VENDA(
                    P_NUNOTA      IN  NUMBER,    -- Número único do pedido
                    P_DTFATURADO  IN  VARCHAR2,  -- Data da emissão da nota no Olist
                    P_IDNFE       IN  NUMBER,    -- ID da NFe gerada no Olist
                    P_NUMNFE      IN  NUMBER,    -- Número da NFe gerada no Olist
                    P_NUNOTA_NOTA OUT NUMBER     -- Número único da nota no Sankhya
) AS
    V_NEWNUNOTA NUMBER;
    V_EXISTETRANSF NUMBER;
BEGIN

    /*******************************************************************************

    @Autor: Rodrigo Vieira <rodrigo.vieira@grupoeisen.com.br>
    @Data: 13/06/2025
    @Objetivo: Gera uma nota a partir do pedido de venda que foi importado do Olist

    ********************************************************************************/

    SELECT COUNT(*)
    INTO V_EXISTETRANSF
    FROM TGFCAB CAB
    WHERE TIPMOV       = 'T'
      AND CODEMP       = 1
      AND CODEMPNEGOC  = 31
      AND CODTIPOPER   = 1419
      AND STATUSNOTA   = 'P'
      AND TRUNC(DTNEG) = TRUNC(CURRENT_DATE);
      
    IF V_EXISTETRANSF = 0 THEN
        AD_STP_MKP_GERA_NOTA_TRANSF;
    END IF;

    STP_KEYGEN_TGFNUM('TGFCAB',1,'TGFCAB','NUNOTA',0, V_NEWNUNOTA);

    -- INSERINDO CABEÇALHO DA NOTA
    INSERT INTO TGFCAB
    (   AD_ABAMERCOS,
        AD_ABATERDEVOLUCAO,
        AD_CODLOCALIVT,
        AD_CONTAGEM,
        AD_CONTP,
        AD_DHCONFIRMVDY,
        AD_DHCRIACAOVDY,
        AD_DTCONTAGEM,
        AD_DTFATURAMENTO,
        AD_IDSHOPEE,
        AD_ISAID,
        AD_ISAORDERNUMBER,
        AD_MKP_CODPED,
        AD_MKP_DESTINO,
        AD_MKP_DHCHECKOUT,
        AD_MKP_ID,
        AD_MKP_IDNFE,
        AD_MKP_NUMPED,
        AD_MKP_ORIGEM,
        AD_NUMCONTRATO,
        AD_NUMLAT,
        AD_NUMLONG,
        AD_NUNOTACONVERSAO,
        AD_NUVIDYA,
        AD_OBSFISCO,
        AD_OFFLINE,
        AD_TAXASHOPEE,
        AD_VDYORIG,
        AGRUPFINNOTA,
        ALIQIRF,
        ANTT,
        APROVADO,
        BASECOFINS,
        BASECOFINSST,
        BASEICMS,
        BASEICMSAT,
        BASEICMSFRETE,
        BASEICMSSTFRETE,
        BASEINSS,
        BASEIPI,
        BASEIRF,
        BASEISS,
        BASEPIS,
        BASEPISST,
        BASESUBSTIT,
        BASESUBSTSEMRED,
        CARACAD,
        CARACSER,
        CHAVECTE,
        CHAVECTEREF,
        CHAVENFCOM,
        CHAVENFE,
        CHAVENFEREF,
        CHAVENFSE,
        CHAVESINIEF1324,
        CHVNFEINEREF,
        CIF_FOB,
        CIOT,
        CLASCONS,
        CLASSIFICMS,
        CLIENTEIDPARCERIA,
        CNPJADQUIRENTE,
        CODART,
        CODCC,
        CODCENCUS,
        CODCHECKOUT,
        CODCID,
        CODCIDDESTINO,
        CODCIDENTREGA,
        CODCIDFIMCTE,
        CODCIDINICTE,
        CODCIDORIGEM,
        CODCIDPREST,
        CODCONTATO,
        CODCONTATOENTREGA,
        CODDOCA,
        CODDOCARRECAD,
        CODEMP,
        CODEMPFUNC,
        CODEMPNEGOC,
        CODFUNC,
        CODGRUPOTENSAO,
        CODGUF,
        CODINTERM,
        CODMAQ,
        CODMODDOCNOTA,
        CODMOEDA,
        CODMOTORISTA,
        CODNAT,
        CODOBRA,
        CODOBSPADRAO,
        CODPARC,
        CODPARCCONSIGNATARIO,
        CODPARCDESCARGAMDFE,
        CODPARCDEST,
        CODPARCREDESPACHO,
        CODPARCREMETENTE,
        CODPARCRETIRADA,
        CODPARCTRANSP,
        CODPARCTRANSPFINAL,
        CODPROJ,
        CODRASTREAMENTOECT,
        CODSITE,
        CODTIPOPER,
        CODTIPVENDA,
        CODTPD,
        CODUFDESTINO,
        CODUFENTREGA,
        CODUFORIGEM,
        CODUSU,
        CODUSUCOMPRADOR,
        CODUSUINC,
        CODVEICULO,
        CODVEND,
        CODVENDTEC,
        CODVTP,
        COMGER,
        COMISSAO,
        CONFIRMNOTAFAT,
        CPFCNPJADQUIRENTE,
        CPFRESPTEC,
        CTEGLOBAL,
        CTELOTACAO,
        DANFE,
        DHEMISSEPEC,
        DHPROTOC,
        DHPROTOCCTE,
        DHREGDPEC,
        DHTIPOPER,
        DHTIPVENDA,
        DHVIAGEM,
        DIGITAL,
        DIRECAOVIAG,
        DISDESAUTIMPEMB,
        DTADIAM,
        DTALTER,
        DTCONTAB,
        DTDECLARA,
        DTENTSAI,
        DTENTSAIINFO,
        DTENVIOPMB,
        DTENVSUF,
        DTESCRCONT,
        DTFATUR,
        DTMOV,
        DTNEG,
        DTPREVENT,
        DTREF,
        DTREF2,
        DTREF3,
        DTREMRET,
        DTVAL,
        EXIGEISSQN,
        FISTEL,
        FORMPGTCTE,
        FRETEVLRPAGO,
        FUSOEMISSEPEC,
        HISTCONFIG,
        HRADIAM,
        HRENTSAI,
        HRMOV,
        ICMSFRETE,
        ICMSSTFRETE,
        IDBALSA01,
        IDBALSA02,
        IDBALSA03,
        IDDESCPARCERIA,
        IDIPROC,
        IDNAVIO,
        IDPONTUACAOPARCERIA,
        INDNEGMODAL,
        INDPRESNFCE,
        INTERMED,
        IPIEMB,
        IRFRETIDO,
        IRINNAVIO,
        ISSRETIDO,
        KMVEICULO,
        LACRES,
        LATITUDE,
        LIBCONF,
        LOCALCOLETA,
        LOCALENTREGA,
        LOCEMBARQ,
        LONGITUDE,
        LOTACAO,
        M3,
        MARCA,
        MD5MODCOMTEL,
        MODELONFDES,
        MODENTREGA,
        MODRECEBPDVWEB,
        MOTNAORETERISSQN,
        NATUREZAOPERDES,
        NFEDEVRECUSA,
        NFSEID,
        NOMEADQUIRENTE,
        NOTAEMPENHO,
        NOTAPORPEDIDOPDV,
        NOTASCF,
        NROCAIXA,
        NROREDZ,
        NUCFR,
        NUCONFATUAL,
        NUFOP,
        NULOTECTE,
        NULOTENFCOM,
        NULOTENFE,
        NULOTENFSE,
        NUMALEATORIO,
        NUMALEATORIOCTE,
        NUMCF,
        NUMCONTRATO,
        NUMCOTACAO,
        NUMCSTC,
        NUMDOCARRECAD,
        NUMERACAOVOLUMES,
        NUMGUIA,
        NUMNFSE,
        NUMNOTA,
        NUMOS,
        NUMPEDIDO2,
        NUMPROTOC,
        NUMPROTOCCTE,
        NUMPROTOCINCTE,
        NUMPROTOCINNFE,
        NUMPROTOCNFCOM,
        NUMRECEITAGRO,
        NUMREGDPEC,
        NUMTERMTEL,
        NUNOTA,
        NUNOTAPEDFRET,
        NUNOTAREC,
        NUNOTASUB,
        NUODP,
        NUPCA,
        NUPEDFRETE,
        NURD8,
        NURECEBIMENTO,
        NUREM,
        NUSESSAO,
        NUTRANSF,
        OBSERVACAO,
        OCCN48,
        ORDEMCARGA,
        PENDENTE,
        PERCDESC,
        PERCDESCFOB,
        PERMALTERCENTRAL,
        PESO,
        PESOBRUTO,
        PESOBRUTOMANUAL,
        PESOLIQUIMANUAL,
        PLACA,
        PREMIACAOESTADUAL,
        PRODPRED,
        PRODUETLOC,
        QTDUSU,
        QTDVOL,
        RATEADO,
        REBOQUE1,
        REBOQUE2,
        REBOQUE3,
        REGESPTRIBUT,
        RETGERWMS,
        RETORNOEQUIPFISCAL,
        SEQCARGA,
        SERIEGUIA,
        SERIENFDES,
        SERIENFSE,
        SERIENOTA,
        SITESPECIALRESP,
        SITUACAOCTE,
        SITUACAONFCOM,
        SOMDESPADUNFENAC,
        SOMICMSNFENAC,
        SOMPISCOFNFENAC,
        STATUSCFE,
        STATUSCTE,
        STATUSNFCOM,
        STATUSNFE,
        STATUSNFSE,
        STATUSNOTA,
        SUMVLRIIOUTNOTA,
        TERMACORDNOTA,
        TIMCONTRATOLTV,
        TIMCONTRATOVENDA,
        TIMNUFINORIG,
        TIMNUNOTAMOD,
        TIMORIGEM,
        TIPCLIENTESERVCOM,
        TIPFRETE,
        TIPIPIEMB,
        TIPMOV,
        TIPNOTAPMB,
        TIPOGUIA,
        TIPOPTAGJNFE,
        TIPPROCIMP,
        TOTALCUSTOPROD,
        TOTALCUSTOSERV,
        TOTDISPDESC,
        TPAMBCTE,
        TPAMBNFCOM,
        TPAMBNFE,
        TPAMBNFSE,
        TPASSINANTE,
        TPEMISCTE,
        TPEMISNFCOM,
        TPEMISNFE,
        TPEMISNFSE,
        TPFRETAMENTO,
        TPLIGACAO,
        TPRETISS,
        TROCO,
        UFADQUIRENTE,
        UFEMBARQ,
        UFEMISS,
        UFEMISSAO,
        UFVEICULO,
        VALORDESONPISCOFINS,
        VENCFRETE,
        VENCIPI,
        VIATRANSP,
        VLRAFRMM,
        VLRCARGAAVERB,
        VLRCOFINS,
        VLRCOFINSST,
        VLRDESCPARCERIA,
        VLRDESCSERV,
        VLRDESCTOT,
        VLRDESCTOTITEM,
        VLRDESCTOTITEMMOE,
        VLRDESTAQUE,
        VLREMB,
        VLRFETHAB,
        VLRFRETE,
        VLRFRETECALC,
        VLRFRETECPL,
        VLRFRETETOTAL,
        VLRICMS,
        VLRICMSAT,
        VLRICMSDIFALDEST,
        VLRICMSDIFALREM,
        VLRICMSEMB,
        VLRICMSFCP,
        VLRICMSFCPINT,
        VLRICMSSEG,
        VLRINDENIZ,
        VLRINDENIZDIST,
        VLRINSS,
        VLRIPI,
        VLRIRF,
        VLRISS,
        VLRJURO,
        VLRJURODIST,
        VLRLIQITEMNFE,
        VLRMERCADORIA,
        VLRMOEDA,
        VLRNOTA,
        VLROUTROS,
        VLRPIS,
        VLRPISST,
        VLRPRESTAFRMM,
        VLRREPREDST,
        VLRREPREDTOT,
        VLRREPREDTOTSEMDESC,
        VLRREPTERC,
        VLRROYALT,
        VLRSEG,
        VLRSTEXTRANOTATOT,
        VLRSTFCPINT,
        VLRSTFCPINTANT,
        VLRSUBST,
        VLRTOTLIQITEMMOE,
        VLRVENDOR,
        VOLUME
    ) 
    SELECT
        CAB.AD_ABAMERCOS,            
        CAB.AD_ABATERDEVOLUCAO,
        CAB.AD_CODLOCALIVT,
        NULL AD_CONTAGEM,
        CAB.AD_CONTP,
        CAB.AD_DHCONFIRMVDY,
        CAB.AD_DHCRIACAOVDY,
        NULL AD_DTCONTAGEM,
        NULL AD_DTFATURAMENTO,
        CAB.AD_IDSHOPEE,
        CAB.AD_ISAID,
        CAB.AD_ISAORDERNUMBER,
        CAB.AD_MKP_CODPED,
        CAB.AD_MKP_DESTINO,  
        TO_DATE(P_DTFATURADO,'YYYY-MM-DD HH24:MI:SS') AD_MKP_DHCHECKOUT,
        CAB.AD_MKP_ID,
        P_IDNFE AD_MKP_IDNFE,
        CAB.AD_MKP_NUMPED,
        CAB.AD_MKP_ORIGEM,
        CAB.AD_NUMCONTRATO,
        CAB.AD_NUMLAT,
        CAB.AD_NUMLONG,
        CAB.AD_NUNOTACONVERSAO,
        CAB.AD_NUVIDYA,
        CAB.AD_OBSFISCO,
        CAB.AD_OFFLINE,
        CAB.AD_TAXASHOPEE,
        CAB.AD_VDYORIG,
        CAB.AGRUPFINNOTA,
        CAB.ALIQIRF,
        CAB.ANTT,
        CAB.APROVADO,
        CAB.BASECOFINS,
        CAB.BASECOFINSST,
        CAB.BASEICMS,
        CAB.BASEICMSAT,
        CAB.BASEICMSFRETE,
        CAB.BASEICMSSTFRETE,
        CAB.BASEINSS,
        CAB.BASEIPI,
        CAB.BASEIRF,
        CAB.BASEISS,
        CAB.BASEPIS,
        CAB.BASEPISST,
        CAB.BASESUBSTIT,
        CAB.BASESUBSTSEMRED,
        CAB.CARACAD,
        CAB.CARACSER,
        CAB.CHAVECTE,
        CAB.CHAVECTEREF,
        CAB.CHAVENFCOM,
        CAB.CHAVENFE,
        CAB.CHAVENFEREF,
        CAB.CHAVENFSE,
        CAB.CHAVESINIEF1324,
        CAB.CHVNFEINEREF,
        CAB.CIF_FOB,
        CAB.CIOT,
        CAB.CLASCONS,
        CAB.CLASSIFICMS,
        CAB.CLIENTEIDPARCERIA,
        CAB.CNPJADQUIRENTE,
        CAB.CODART,
        CAB.CODCC,
        CAB.CODCENCUS,
        CAB.CODCHECKOUT,
        CAB.CODCID,
        CAB.CODCIDDESTINO,
        CAB.CODCIDENTREGA,
        CAB.CODCIDFIMCTE,
        CAB.CODCIDINICTE,
        CAB.CODCIDORIGEM,
        CAB.CODCIDPREST,
        CAB.CODCONTATO,
        CAB.CODCONTATOENTREGA,
        CAB.CODDOCA,
        CAB.CODDOCARRECAD,
        CAB.CODEMP,
        CAB.CODEMPFUNC,
        CAB.CODEMPNEGOC,
        CAB.CODFUNC,
        CAB.CODGRUPOTENSAO,
        CAB.CODGUF,
        CAB.CODINTERM,
        CAB.CODMAQ,
        CAB.CODMODDOCNOTA,
        CAB.CODMOEDA,
        CAB.CODMOTORISTA,
        CAB.CODNAT,
        CAB.CODOBRA,
        CAB.CODOBSPADRAO,
        CAB.CODPARC,
        CAB.CODPARCCONSIGNATARIO,
        CAB.CODPARCDESCARGAMDFE,
        CAB.CODPARCDEST,
        CAB.CODPARCREDESPACHO,
        CAB.CODPARCREMETENTE,
        CAB.CODPARCRETIRADA,
        CAB.CODPARCTRANSP,
        CAB.CODPARCTRANSPFINAL,
        CAB.CODPROJ,
        CAB.CODRASTREAMENTOECT,
        CAB.CODSITE,
        TOP.CODTIPOPERDESTINO,
        CAB.CODTIPVENDA,
        CAB.CODTPD,
        CAB.CODUFDESTINO,
        CAB.CODUFENTREGA,
        CAB.CODUFORIGEM,
        CAB.CODUSU,
        CAB.CODUSUCOMPRADOR,
        CAB.CODUSUINC,
        CAB.CODVEICULO,
        CAB.CODVEND,
        CAB.CODVENDTEC,
        CAB.CODVTP,
        CAB.COMGER,
        CAB.COMISSAO,
        CAB.CONFIRMNOTAFAT,
        CAB.CPFCNPJADQUIRENTE,
        CAB.CPFRESPTEC,
        CAB.CTEGLOBAL,
        CAB.CTELOTACAO,
        CAB.DANFE,
        CAB.DHEMISSEPEC,
        CAB.DHPROTOC,
        CAB.DHPROTOCCTE,
        CAB.DHREGDPEC,
        DESTOP.DHALTER DHTIPOPER,
        TPV.DHALTER DHTIPVENDA,
        CAB.DHVIAGEM,
        CAB.DIGITAL,
        CAB.DIRECAOVIAG,
        CAB.DISDESAUTIMPEMB,
        CAB.DTADIAM,
        SYSDATE DTALTER,
        CAB.DTCONTAB,
        CAB.DTDECLARA,
        TRUNC(SYSDATE) DTENTSAI,
        CAB.DTENTSAIINFO,
        CAB.DTENVIOPMB,
        CAB.DTENVSUF,
        CAB.DTESCRCONT,
        TO_DATE(P_DTFATURADO,'YYYY-MM-DD HH24:MI:SS') DTFATUR,
        TRUNC(SYSDATE) DTMOV,
        TRUNC(TO_DATE(P_DTFATURADO,'YYYY-MM-DD HH24:MI:SS')) DTNEG,
        CAB.DTPREVENT,
        CAB.DTREF,
        CAB.DTREF2,
        CAB.DTREF3,
        CAB.DTREMRET,
        CAB.DTVAL,
        CAB.EXIGEISSQN,
        CAB.FISTEL,
        CAB.FORMPGTCTE,
        CAB.FRETEVLRPAGO,
        CAB.FUSOEMISSEPEC,
        CAB.HISTCONFIG,
        CAB.HRADIAM,
        SYSDATE HRENTSAI,
        TO_NUMBER(TO_CHAR(SYSDATE,'HH24MISS')) HRMOV,
        CAB.ICMSFRETE,
        CAB.ICMSSTFRETE,
        CAB.IDBALSA01,
        CAB.IDBALSA02,
        CAB.IDBALSA03,
        CAB.IDDESCPARCERIA,
        CAB.IDIPROC,
        CAB.IDNAVIO,
        CAB.IDPONTUACAOPARCERIA,
        0 INDNEGMODAL,
        CAB.INDPRESNFCE,
        CAB.INTERMED,
        CAB.IPIEMB,
        DESTOP.TEMIRF IRFRETIDO,
        CAB.IRINNAVIO,
        DESTOP.TEMISS ISSRETIDO,
        CAB.KMVEICULO,
        CAB.LACRES,
        CAB.LATITUDE,
        CAB.LIBCONF,
        CAB.LOCALCOLETA,
        CAB.LOCALENTREGA,
        CAB.LOCEMBARQ,
        CAB.LONGITUDE,
        CAB.LOTACAO,
        CAB.M3,
        CAB.MARCA,
        CAB.MD5MODCOMTEL,
        CAB.MODELONFDES,
        CAB.MODENTREGA,
        CAB.MODRECEBPDVWEB,
        CAB.MOTNAORETERISSQN,
        CAB.NATUREZAOPERDES,
        CAB.NFEDEVRECUSA,
        CAB.NFSEID,
        CAB.NOMEADQUIRENTE,
        CAB.NOTAEMPENHO,
        CAB.NOTAPORPEDIDOPDV,
        CAB.NOTASCF,
        CAB.NROCAIXA,
        CAB.NROREDZ,
        CAB.NUCFR,
        CAB.NUCONFATUAL,
        CAB.NUFOP,
        CAB.NULOTECTE,
        CAB.NULOTENFCOM,
        CAB.NULOTENFE,
        CAB.NULOTENFSE,
        CAB.NUMALEATORIO,
        CAB.NUMALEATORIOCTE,
        CAB.NUMCF,
        CAB.NUMCONTRATO,
        CAB.NUMCOTACAO,
        CAB.NUMCSTC,
        CAB.NUMDOCARRECAD,
        CAB.NUMERACAOVOLUMES,
        CAB.NUMGUIA,
        CAB.NUMNFSE,
        P_NUMNFE NUMNOTA,
        CAB.NUMOS,
        CAB.NUMPEDIDO2,
        CAB.NUMPROTOC,
        CAB.NUMPROTOCCTE,
        CAB.NUMPROTOCINCTE,
        CAB.NUMPROTOCINNFE,
        CAB.NUMPROTOCNFCOM,
        CAB.NUMRECEITAGRO,
        CAB.NUMREGDPEC,
        CAB.NUMTERMTEL,
        V_NEWNUNOTA NUNOTA,
        CAB.NUNOTAPEDFRET,
        CAB.NUNOTAREC,
        CAB.NUNOTASUB,
        CAB.NUODP,
        CAB.NUPCA,
        CAB.NUPEDFRETE,
        CAB.NURD8,
        CAB.NURECEBIMENTO,
        CAB.NUREM,
        CAB.NUSESSAO,
        CAB.NUTRANSF,
        CAB.OBSERVACAO,
        CAB.OCCN48,
        CAB.ORDEMCARGA,
        CAB.PENDENTE,
        CAB.PERCDESC,
        CAB.PERCDESCFOB,
        CAB.PERMALTERCENTRAL,
        CAB.PESO,
        CAB.PESOBRUTO,
        CAB.PESOBRUTOMANUAL,
        CAB.PESOLIQUIMANUAL,
        CAB.PLACA,
        CAB.PREMIACAOESTADUAL,
        CAB.PRODPRED,
        CAB.PRODUETLOC,
        CAB.QTDUSU,
        CAB.QTDVOL,
        CAB.RATEADO,
        CAB.REBOQUE1,
        CAB.REBOQUE2,
        CAB.REBOQUE3,
        CAB.REGESPTRIBUT,
        CAB.RETGERWMS,
        CAB.RETORNOEQUIPFISCAL,
        CAB.SEQCARGA,
        CAB.SERIEGUIA,
        CAB.SERIENFDES,
        CAB.SERIENFSE,
        1 SERIENOTA,
        CAB.SITESPECIALRESP,
        CAB.SITUACAOCTE,
        CAB.SITUACAONFCOM,
        CAB.SOMDESPADUNFENAC,
        CAB.SOMICMSNFENAC,
        CAB.SOMPISCOFNFENAC,
        CAB.STATUSCFE,
        CAB.STATUSCTE,
        CAB.STATUSNFCOM,
        CAB.STATUSNFE,
        CAB.STATUSNFSE,
        'P' STATUSNOTA,
        CAB.SUMVLRIIOUTNOTA,
        CAB.TERMACORDNOTA,
        CAB.TIMCONTRATOLTV,
        CAB.TIMCONTRATOVENDA,
        CAB.TIMNUFINORIG,
        CAB.TIMNUNOTAMOD,
        CAB.TIMORIGEM,
        CAB.TIPCLIENTESERVCOM,
        CAB.TIPFRETE,
        CAB.TIPIPIEMB,
        DESTOP.TIPMOV,
        CAB.TIPNOTAPMB,
        CAB.TIPOGUIA,
        CAB.TIPOPTAGJNFE,
        CAB.TIPPROCIMP,
        CAB.TOTALCUSTOPROD,
        CAB.TOTALCUSTOSERV,
        CAB.TOTDISPDESC,
        CAB.TPAMBCTE,
        CAB.TPAMBNFCOM,
        CAB.TPAMBNFE,
        CAB.TPAMBNFSE,
        CAB.TPASSINANTE,
        CAB.TPEMISCTE,
        CAB.TPEMISNFCOM,
        CAB.TPEMISNFE,
        CAB.TPEMISNFSE,
        CAB.TPFRETAMENTO,
        CAB.TPLIGACAO,
        CAB.TPRETISS,
        CAB.TROCO,
        CAB.UFADQUIRENTE,
        CAB.UFEMBARQ,
        CAB.UFEMISS,
        CAB.UFEMISSAO,
        CAB.UFVEICULO,
        CAB.VALORDESONPISCOFINS,
        CAB.VENCFRETE,
        CAB.VENCIPI,
        CAB.VIATRANSP,
        CAB.VLRAFRMM,
        CAB.VLRCARGAAVERB,
        CAB.VLRCOFINS,
        CAB.VLRCOFINSST,
        CAB.VLRDESCPARCERIA,
        CAB.VLRDESCSERV,
        CAB.VLRDESCTOT,
        CAB.VLRDESCTOTITEM,
        CAB.VLRDESCTOTITEMMOE,
        CAB.VLRDESTAQUE,
        CAB.VLREMB,
        CAB.VLRFETHAB,
        CAB.VLRFRETE,
        CAB.VLRFRETECALC,
        CAB.VLRFRETECPL,
        CAB.VLRFRETETOTAL,
        CAB.VLRICMS,
        CAB.VLRICMSAT,
        CAB.VLRICMSDIFALDEST,
        CAB.VLRICMSDIFALREM,
        CAB.VLRICMSEMB,
        CAB.VLRICMSFCP,
        CAB.VLRICMSFCPINT,
        CAB.VLRICMSSEG,
        CAB.VLRINDENIZ,
        CAB.VLRINDENIZDIST,
        CAB.VLRINSS,
        CAB.VLRIPI,
        CAB.VLRIRF,
        CAB.VLRISS,
        CAB.VLRJURO,
        CAB.VLRJURODIST,
        CAB.VLRLIQITEMNFE,
        CAB.VLRMERCADORIA,
        CAB.VLRMOEDA,
        CAB.VLRNOTA,
        CAB.VLROUTROS,
        CAB.VLRPIS,
        CAB.VLRPISST,
        CAB.VLRPRESTAFRMM,
        CAB.VLRREPREDST,
        CAB.VLRREPREDTOT,
        CAB.VLRREPREDTOTSEMDESC,
        CAB.VLRREPTERC,
        CAB.VLRROYALT,
        CAB.VLRSEG,
        CAB.VLRSTEXTRANOTATOT,
        CAB.VLRSTFCPINT,
        CAB.VLRSTFCPINTANT,
        CAB.VLRSUBST,
        CAB.VLRTOTLIQITEMMOE,
        CAB.VLRVENDOR,
        CAB.VOLUME
    FROM TGFCAB CAB
        INNER JOIN TGFTOP TOP    ON CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER
        INNER JOIN TGFTOP DESTOP ON DESTOP.CODTIPOPER = TOP.CODTIPOPERDESTINO AND DESTOP.DHALTER = (SELECT MAX(DHALTER) FROM TGFTOP AUXTOP WHERE AUXTOP.CODTIPOPER = DESTOP.CODTIPOPER AND TRUNC(AUXTOP.DHALTER) <= TRUNC(TO_DATE(P_DTFATURADO,'YYYY-MM-DD HH24:MI:SS')))
        INNER JOIN TGFTPV TPV    ON CAB.CODTIPVENDA = TPV.CODTIPVENDA AND CAB.DHTIPVENDA = TPV.DHALTER
    WHERE CAB.NUNOTA = P_NUNOTA;

    P_NUNOTA_NOTA := V_NEWNUNOTA;

    COMMIT;
END;