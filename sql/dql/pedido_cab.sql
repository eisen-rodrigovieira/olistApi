SELECT
    CAB.NUNOTA,
    CAB.NUMNOTA,
    CAB.AD_MKP_CODPED,
    CAB.AD_MKP_DESTINO,
    CAB.AD_MKP_DHCHECKOUT,
    CAB.AD_MKP_DHSEPARACAO,
    CAB.AD_MKP_ID,
    CAB.AD_MKP_IDNFE,
    CAB.AD_MKP_IDSEPARACAO,
    CAB.AD_MKP_NUMPED,
    CAB.AD_MKP_ORIGEM,
    CAB.CODEMP,
    CAB.CODCENCUS,
    CAB.DTNEG,
    CAB.DTMOV,
    CAB.DTALTER,
    CASE WHEN CAB.STATUSNOTA = 'L' THEN 'S' ELSE 'N' END CONFIRMADA,
    CAB.PENDENTE,
    CAB.CODEMPNEGOC,
    CAB.CODPARC,
    CAB.CODTIPOPER,
    CAB.DHTIPOPER,
    CAB.TIPMOV,
    CAB.CODTIPVENDA,
    CAB.DHTIPVENDA,
    CAB.CODVEND,
    CAB.OBSERVACAO,
    CAB.VLRDESCTOT,
    CAB.VLRDESCTOTITEM,
    CAB.VLRFRETE,
    CAB.CIF_FOB,
    CAB.VLRNOTA,
    CAB.QTDVOL,
    CAB.BASEICMS,
    CAB.VLRICMS,
    CAB.BASEIPI,
    CAB.VLRIPI,
    CAB.ISSRETIDO,
    CAB.BASEISS,
    CAB.VLRISS,
    CAB.APROVADO,
    CAB.CODUSU,
    CAB.IRFRETIDO,
    CAB.VLRIRF,
    CAB.VOLUME,
    CAB.VLRSUBST,
    CAB.BASESUBSTIT,
    CAB.PESO,
    CAB.CODNAT,
    CAB.VLRFRETECPL,
    CAB.CODUSUINC,
    CAB.BASEIRF,
    CAB.ALIQIRF,
    CAB.PESOBRUTO,
    CAB.HRENTSAI,
    CAB.LIBCONF,
    CAB.VLRICMSDIFALDEST,
    CAB.VLRICMSDIFALREM,
    CAB.VLRICMSFCP,
    CAB.CODCIDORIGEM,
    CAB.CODCIDDESTINO,
    CAB.CODCIDENTREGA,
    CAB.CODUFORIGEM,
    CAB.CODUFDESTINO,
    CAB.CODUFENTREGA,
    CAB.CLASSIFICMS,
    CAB.VLRICMSFCPINT,
    CAB.VLRSTFCPINTANT,
    CAB.STATUSCFE,
    CAB.HISTCONFIG,
    CAB.AD_IDSHOPEE,
    CAB.AD_TAXASHOPEE,
    (SELECT MAX(ITE.SEQUENCIA) FROM TGFITE ITE WHERE ITE.NUNOTA = CAB.NUNOTA) QTDITE,
    (SELECT COUNT(1) FROM TGFFIN FIN WHERE FIN.NUNOTA = CAB.NUNOTA) QTDFIN
FROM TGFCAB CAB
WHERE 1=1
    AND CAB.NUNOTA = NVL(:NUNOTA,CAB.NUNOTA)
    AND CAB.AD_MKP_ID = NVL(:ID,AD_MKP_ID)
    AND CAB.AD_MKP_CODPED = NVL(:ECOMMERCE,AD_MKP_CODPED)